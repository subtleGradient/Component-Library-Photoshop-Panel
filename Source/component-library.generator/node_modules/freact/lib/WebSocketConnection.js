exports = module.exports = WebSocketConnection;

function WebSocketConnection(config, state, key){
  if (state.socket && state.isOpen && config.message != state.messageSent) {
    state.socket.send(config.message);
    state.messageSent = config.message;
    if (state.onchange) state.onchange();
  }
  if (state.socket && state.url != config.url) {
    state.socket.close();
    state.socket = null;
  }
  if (state.socket) return state;
  
  if (WebSocketConnection.WebSocket == null){
    if (typeof WebSocket != 'undefined') WebSocketConnection.WebSocket = WebSocket;
    else WebSocketConnection.WebSocket = require('ws');
  }
  state.socket = new WebSocketConnection.WebSocket(config.url);
  
  state.url = config.url;
  
  state.isOpen = false;
  
  state.socket.onopen = function(){
    state.isOpen = true;
    if (state.onchange) state.onchange();
  };
  state.socket.onclose = function(){
    state.isOpen = false;
    if (state.onchange) state.onchange();
  };
  state.socket.onerror = function(error){
    state.error = error;
    if (state.onchange) state.onchange();
  };
  state.socket.onmessage = function(event){
    state.messageReceived = event.data;
    if (state.onchange) state.onchange();
  };
  
  if (state.onchange) state.onchange();
  return state;
}
